# =============================================================================
# Docker Compose for Doc Parser API with ROCm (AMD GPU)
#
# Usage:
#   docker compose up --build
#   curl -X POST http://localhost:8000/process -F "file=@document.pdf"
#
# Host requirements:
#   - amdgpu driver + ROCm installed
#   - User in video and render groups
# =============================================================================

services:
  doc-parser:
    build: .
    container_name: doc-parser-api
    ports:
      - "8000:8000"

    # Volumes
    volumes:
      - ./output:/app/output
      # Persist doctr/torch model cache so models aren't re-downloaded on restart
      - doctr-cache:/root/.cache

    # AMD GPU access via ROCm
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
      - render

    # ROCm recommendations (AMD quick-start)
    ipc: host
    security_opt:
      - seccomp=unconfined
    shm_size: "8g"

    # Environment variables
    env_file:
      - .env
    environment:
      # gfx1100 = RDNA3 (RX 7900 XT) â€” safety net for ROCm < 7.2
      - HSA_OVERRIDE_GFX_VERSION=11.0.0
      # PyTorch memory allocation optimization
      - PYTORCH_HIP_ALLOC_CONF=max_split_size_mb:512

    restart: unless-stopped

# Named volumes
volumes:
  doctr-cache:
